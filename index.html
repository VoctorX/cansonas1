<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Optimizador de Servicios - Control Total S.A.S</title>
    <!-- Incluye Tailwind CSS CDN para el estilo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Incluye la librer√≠a de Chart.js para dibujar gr√°ficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- Incluye la librer√≠a de Programaci√≥n Lineal (Simplex Solver) - Mantenida para futuros cambios de restricciones -->
    <script src="https://cdn.jsdelivr.net/npm/javascript-lp-solver/prod/solver.js"></script>
    
    <style>
        /* Definici√≥n general de inputs base */
        .input-group {
            @apply mb-6 p-4 rounded-xl border-2 border-gray-300 hover:border-purple-400 transition-all;
            background: linear-gradient(to right, #f0f9ff, #e6f7ff);
        }
        
        .input-group label {
            @apply text-lg font-bold mb-2 block;
        }
        
        .input-group input {
            @apply w-full p-3 text-2xl font-bold rounded-lg shadow-inner;
            border: 3px solid #cbd5e1;
        }
        
        /* R1 - Azul */
        #R1_limite {
            @apply bg-blue-100 border-blue-500 focus:ring-4 focus:ring-blue-200;
            color: #1e40af;
        }

        /* R2 - Rojo */
        #R2_minimo {
            @apply bg-red-100 border-red-500 focus:ring-4 focus:ring-red-200;
            color: #dc2626;
        }

        /* R3 - P√∫rpura */
        #R3_equipos {
            @apply bg-purple-100 border-purple-500 focus:ring-4 focus:ring-purple-200;
            color: #6b21a8;
        }

        /* C1/C2 - Verde */
        #C1_ganancia, #C2_ganancia {
            @apply bg-green-100 border-green-500 focus:ring-4 focus:ring-green-200;
            color: #15803d;
        }

        /* ESTABILIZACI√ìN: Fuerza la relaci√≥n de aspecto 1:1 para el gr√°fico */
        #chart-container {
            width: 100%;
            max-width: 550px;
            aspect-ratio: 1 / 1; 
            margin: 0 auto;
        }
    </style>
</head>
<body class="bg-gray-100 p-8 font-sans">

    <div class="max-w-6xl mx-auto bg-white shadow-2xl shadow-purple-200 rounded-2xl p-10 border-t-8 border-purple-600">
        <header class="text-center mb-10">
            <h1 class="text-4xl font-extrabold text-purple-800 flex items-center justify-center space-x-3">
                <span>üìä</span>
                <span>Modelo de Optimizaci√≥n de Tareas (Franja 9am-12pm)</span>
            </h1>
            <p class="text-xl text-gray-600 mt-2">Distribuci√≥n √ìptima de Empleados entre dos Unidades de Trabajo/Producto (Control Total S.A.S)</p>
        </header>

        <!-- SECCI√ìN DE FORMULACI√ìN MATEM√ÅTICA FORMAL - CONTEXTUALIZADA PARA FUMIGACI√ìN -->
        <div class="bg-purple-50 p-6 rounded-xl shadow-inner mb-10">
            <h2 class="text-2xl font-bold text-purple-900 mb-4 border-b border-purple-200 pb-2">Formulaci√≥n Matem√°tica del Problema (Asignaci√≥n 9am-12pm)</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-sm">
                <div>
                    <h3 class="font-semibold text-lg text-gray-700">Variables de Decisi√≥n:</h3>
                    <ul class="list-disc list-inside ml-4 text-gray-800 space-y-1">
                        <li>X = Empleados en Servicio Alta Rentabilidad</li>
                        <li>Y = Empleados en Servicio Baja Rentabilidad</li>
                    </ul>
                </div>
                <div>
                    <h3 class="font-semibold text-lg text-gray-700">Funci√≥n Objetivo:</h3>
                    <p class="bg-purple-200 p-2 rounded font-mono text-xl text-purple-900 mt-1 shadow-md">
                        MAX Z = 120X + 80Y
                    </p>
                    <p class="text-xs text-gray-600 mt-2">Beneficio en miles de COP por empleado</p>
                </div>
                <div>
                    <h3 class="font-semibold text-lg text-gray-700">Restricciones:</h3>
                    <ul class="list-disc list-inside ml-4 text-gray-800 space-y-1">
                        <li class="font-mono text-blue-700 font-bold">X + Y ‚â§ 13 (Personal Total)</li>
                        <li class="font-mono text-red-600 font-bold">Y ‚â• 3 (M√≠nimo Servicio B√°sico)</li>
                        <li class="font-mono text-purple-700 font-bold">2X + Y ‚â§ 18 (L√≠mite Equipos)</li>
                        <li class="font-mono">X, Y ‚â• 0 (No Negatividad)</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Secci√≥n de Controles y Resultados -->
        <div class="grid grid-cols-1 lg:grid-cols-5 gap-10">
            <!-- Columna de Controles (2/5) -->
            <div class="lg:col-span-2">
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 mb-6">
                    <h2 class="text-xl font-bold text-purple-700 mb-4 border-b pb-2">‚öôÔ∏è Par√°metros de Optimizaci√≥n (Franja 9am-12pm)</h2>
                    
                    <div class="input-group mb-4">
                        <label class="block text-sm font-medium text-blue-700 font-semibold mb-1">R1: L√≠mite M√°ximo de Empleados Disponibles (X + Y ‚â§)</label>
                        <input type="number" id="R1_limite" value="13" min="1" step="1" onchange="resolverYGraficar()">
                    </div>
                    
                    <div class="input-group mb-4">
                        <label class="block text-sm font-medium text-red-600 font-semibold mb-1">R2: Empleados M√≠nimos Requeridos para Cobertura (Y ‚â•)</label>
                        <input type="number" id="R2_minimo" value="3" min="1" step="1" onchange="resolverYGraficar()">
                    </div>

                    <div class="input-group mb-4">
                        <label class="block text-sm font-medium text-purple-700 font-semibold mb-1">R3: L√≠mite de Unidades de Flota/Equipo (2X + 1Y ‚â§)</label>
                        <input type="number" id="R3_equipos" value="18" min="1" step="1" onchange="resolverYGraficar()">
                        <p class="text-xs text-gray-500 mt-1">Asume: Tarea X consume 2 unidades de equipo; Tarea Y consume 1 unidad.</p>
                    </div>

                    <div class="input-group mb-4">
                        <label class="block text-sm font-medium text-green-700 font-semibold mb-1">C1: Beneficio por Empleado en Unidad X (x 1000 COP)</label>
                        <input type="number" id="C1_ganancia" value="120" min="1" step="1" onchange="resolverYGraficar()">
                    </div>

                    <div class="input-group">
                        <label class="block text-sm font-medium text-green-700 font-semibold mb-1">C2: Beneficio por Empleado en Unidad Y (x 1000 COP)</label>
                        <input type="number" id="C2_ganancia" value="80" min="1" step="1" onchange="resolverYGraficar()">
                    </div>
                </div>

                <div id="resultados" class="bg-green-100 p-6 rounded-xl border border-green-300 shadow-md">
                    <p class="text-gray-500">Resultados del Plan de Optimizaci√≥n.</p>
                </div>
            </div>

            <!-- Columna del Gr√°fico (3/5) -->
            <div class="lg:col-span-3">
                <h2 class="text-xl font-bold text-gray-800 mb-4 text-center">Gr√°fico de la Soluci√≥n (Regi√≥n Factible 9am-12pm)</h2>
                <div id="chart-container" class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                    <canvas id="simplexChart"></canvas>
                </div>
                <p class="text-xs text-center text-gray-500 mt-3">El **punto rojo (‚òÖ)** indica la distribuci√≥n √≥ptima de empleados entre la Unidad X (Mayor Rentabilidad) y la Unidad Y (Menor Rentabilidad).</p>
            </div>
        </div>
    </div>

    <!-- Script de JavaScript y L√≥gica de Gr√°fico -->
    <script>
        let myChart;
        
        // Funci√≥n auxiliar para resolver un sistema 2x2: a1*x + b1*y = c1, a2*x + b2*y = c2
        function solve2x2(a1, b1, c1, a2, b2, c2) {
            const determinant = a1 * b2 - a2 * b1;
            if (Math.abs(determinant) < 1e-9) { // Casi cero, l√≠neas paralelas o id√©nticas
                return null; 
            }
            const x = (c1 * b2 - c2 * b1) / determinant;
            const y = (a1 * c2 - a2 * c1) / determinant;
            return { x: x, y: y };
        }

        // Funci√≥n para verificar si un punto (x, y) es una soluci√≥n factible
        function isFeasible(x, y, R1, R2, R3) {
            // No Negatividad
            if (x < -1e-9 || y < -1e-9) return false; 
            
            // R1: X + Y <= R1 (L√≠mite General de Personal)
            if (x + y > R1 + 1e-9) return false; 
            
            // R2: Y >= R2 (M√≠nimo Obligatorio Cobertura)
            if (y < R2 - 1e-9) return false; 
            
            // R3: 2X + 1Y <= R3 (L√≠mite de Equipo)
            if (2 * x + y > R3 + 1e-9) return false; 
            
            return true;
        }

        function resolverYGraficar() {
            // 1. Obtener valores de los inputs
            const R1_limite = parseFloat(document.getElementById('R1_limite').value);
            const R2_minimo = parseFloat(document.getElementById('R2_minimo').value);
            const R3_equipos = parseFloat(document.getElementById('R3_equipos').value);
            const C1_scaled = parseFloat(document.getElementById('C1_ganancia').value); 
            const C2_scaled = parseFloat(document.getElementById('C2_ganancia').value); 
            
            const SCALE_FACTOR = 1000;

            // 2. Verificaci√≥n de infactibilidad inicial (l√≥gica y de entrada)
            if (isNaN(R1_limite) || isNaN(R2_minimo) || isNaN(R3_equipos) || isNaN(C1_scaled) || isNaN(C2_scaled) || R1_limite <= 0 || R2_minimo < 0 || R3_equipos <= 0 || C1_scaled <= 0 || C2_scaled <= 0) {
                let errorMsg = 'Error: Los l√≠mites (R1, R3, C1, C2) deben ser positivos.';
                document.getElementById('resultados').innerHTML = `<p class="text-lg font-bold text-red-600">‚ùå ${errorMsg}</p>`;
                if (myChart) myChart.destroy();
                return;
            }
            
            // Verificar si el m√≠nimo requerido (R2) excede la capacidad total (R1) o la capacidad de equipo (R3)
            if (R2_minimo > R1_limite || R2_minimo > R3_equipos) {
                 let errorMsg = 'Infactibilidad: El m√≠nimo requerido (R2) excede la Capacidad M√°xima de Personal (R1) o la Capacidad de Equipo (R3).';
                 document.getElementById('resultados').innerHTML = `<p class="text-lg font-bold text-red-600">‚ùå ${errorMsg}</p>`;
                 if (myChart) myChart.destroy();
                 return;
            }


            // 3. C√ÅLCULO DETERMIN√çSTICO: ENUMERACI√ìN DE V√âRTICES CANDIDATOS
            let candidateVertices = [];
            
            // L√çNEAS PRINCIPALES:
            // L1 (R1): X + Y = R1_limite   -> a1=1, b1=1, c1=R1_limite
            // L2 (R2): Y = R2_minimo       -> a2=0, b2=1, c2=R2_minimo
            // L3 (R3): 2X + Y = R3_equipos -> a3=2, b3=1, c3=R3_equipos
            // L4 (X=0): X = 0             -> a4=1, b4=0, c4=0
            
            
            // Intersecciones 2x2:

            // I1: L4 (X=0) y L2 (Y=R2)
            candidateVertices.push({ x: 0, y: R2_minimo });
            
            // I2: L4 (X=0) y L1 (X+Y=R1)
            candidateVertices.push({ x: 0, y: R1_limite });
            
            // I3: L4 (X=0) y L3 (2X+Y=R3)
            candidateVertices.push({ x: 0, y: R3_equipos });
            
            // I4: L1 (X+Y=R1) y L2 (Y=R2)
            // X + R2 = R1 -> X = R1 - R2
            candidateVertices.push({ x: R1_limite - R2_minimo, y: R2_minimo });
            
            // I5: L3 (2X+Y=R3) y L2 (Y=R2)
            // 2X + R2 = R3 -> X = (R3 - R2) / 2
            candidateVertices.push({ x: (R3_equipos - R2_minimo) / 2, y: R2_minimo });
            
            // I6: L1 (X+Y=R1) y L3 (2X+Y=R3)
            const intersection_L1_L3 = solve2x2(1, 1, R1_limite, 2, 1, R3_equipos);
            if (intersection_L1_L3) {
                 candidateVertices.push(intersection_L1_L3);
            }
            
            // 4. Filtrar y Evaluar V√©rtices Factibles
            let factibleVertices = [];
            
            candidateVertices.forEach(p => {
                // Redondear el punto para evitar problemas de flotantes y mantener la integridad de empleados
                p.x = parseFloat(p.x.toFixed(6));
                p.y = parseFloat(p.y.toFixed(6));

                if (isFeasible(p.x, p.y, R1_limite, R2_minimo, R3_equipos)) {
                    // C√ÅLCULO DE LA FUNCI√ìN OBJETIVO para el v√©rtice factible
                    p.Z = (C1_scaled * p.x) + (C2_scaled * p.y);
                    factibleVertices.push(p);
                }
            });

            // 5. Encontrar la Soluci√≥n √ìptima
            let optX = 0;
            let optY = 0;
            let maxZ = -Infinity;

            if (factibleVertices.length === 0) {
                 // Si la regi√≥n factible es vac√≠a, los valores √≥ptimos siguen siendo 0.
            } else {
                 factibleVertices.forEach(p => {
                    if (p.Z > maxZ) {
                        maxZ = p.Z;
                        optX = Math.round(p.x); // Redondeo para n√∫mero de empleados
                        optY = Math.round(p.y); // Redondeo para n√∫mero de empleados
                    }
                 });
            }

            // 6. Mostrar Resultados
            const resultadosDiv = document.getElementById('resultados');
            let output = '';
            // El l√≠mite superior del gr√°fico debe ser el mayor de R1 o R3
            let maxBoundary = Math.ceil(Math.max(R1_limite, R3_equipos)) + 2; 

            // Re-evaluar Z en el punto entero redondeado final (optX, optY)
            const finalZ_scaled = (C1_scaled * optX) + (C2_scaled * optY);
            
            if (finalZ_scaled > 0 && isFeasible(optX, optY, R1_limite, R2_minimo, R3_equipos)) {
                // Re-escalar el resultado final para mostrarlo en COP
                const finalResult = finalZ_scaled * SCALE_FACTOR; 

                output += '<p class="text-xl font-bold text-green-700 mb-3 flex items-center">‚ú® Plan de Asignaci√≥n √ìptimo</p>';
                output += `<p class="text-2xl font-extrabold mb-4 text-purple-800">Ganancia Potencial (MAX Z): <span class="text-red-600">${Math.round(finalResult).toLocaleString('es-CO')} COP</span></p>`;
                
                output += '<h3 class="text-lg font-semibold mt-4 mb-2 border-b border-green-200 pb-1">Distribuci√≥n de Empleados (V√©rtice √ìptimo):</h3>';
                output += '<ul class="list-disc list-inside space-y-2 mt-2">';
                output += `<li class="text-gray-800">X (Unidad Mayor Rentabilidad): Asignar <strong>${optX}</strong> empleados.</li>`; 
                output += `<li class="text-gray-800">Y (Unidad Menor Rentabilidad): Asignar <strong>${optY}</strong> empleados.</li>`;
                output += '</ul>';
                output += `<p class="text-sm text-gray-600 mt-4">Nota: La asignaci√≥n total es de ${optX + optY} empleados en la franja 9am-12pm.</p>`;


            } else {
                output += '<p class="text-lg font-bold text-red-600">‚ùå Soluci√≥n Trivial o No Factible.</p>';
                output += '<p class="text-gray-700">La ganancia √≥ptima es cero, o el modelo no puede satisfacer los requerimientos. Revise los par√°metros R1, R2 y R3.</p>';
            }
            resultadosDiv.innerHTML = output;

            // 7. Graficar la Regi√≥n Factible y el Punto √ìptimo
            dibujarGrafico(R1_limite, R2_minimo, R3_equipos, optX, optY, maxBoundary);
        }

        function dibujarGrafico(R1, R2, R3, optX, optY, maxBoundary) {
            const ctx = document.getElementById('simplexChart').getContext('2d');
            
            if (myChart) {
                myChart.destroy(); // Destruye el gr√°fico anterior
            }
            
            // Puntos para las l√≠neas de restricci√≥n
            
            // R1: X + Y = R1 -> Puntos (R1, 0) y (0, R1)
            const R1_line = [{ x: 0, y: R1 }, { x: R1, y: 0 }]; 
            
            // R2: Y = R2 -> L√≠nea horizontal
            const R2_line = [{ x: 0, y: R2 }, { x: maxBoundary, y: R2 }];
            
            // R3: 2X + Y = R3 -> Puntos (R3/2, 0) y (0, R3)
            const R3_line = [{ x: R3 / 2, y: 0 }, { x: 0, y: R3 }];
            

            myChart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [
                        // R1: L√≠mite General de Personal (X + Y ‚â§ R1)
                        {
                            label: `R1 (M√°x. Personal): X + Y ‚â§ ${R1}`,
                            data: R1_line,
                            borderColor: 'rgb(54, 162, 235)', // Azul
                            borderWidth: 3, 
                            showLine: true,
                            fill: false,
                            pointRadius: 0
                        },
                        // R2: L√≠mite M√≠nimo Obligatorio para Y (Y ‚â• R2)
                        {
                            label: `R2 (M√≠nimo Obligatorio): Y ‚â• ${R2}`,
                            data: R2_line,
                            borderColor: 'rgb(255, 99, 132)', // Rojo/Rosa
                            borderWidth: 3,
                            showLine: true,
                            fill: false,
                            pointRadius: 0
                        },
                        // R3: L√≠mite de Equipo (2X + 1Y ‚â§ R3)
                        {
                            label: `R3 (M√°x. Equipo/Flota): 2X + 1Y ‚â§ ${R3}`,
                            data: R3_line,
                            borderColor: 'rgb(148, 0, 211)', // P√∫rpura
                            borderWidth: 3,
                            showLine: true,
                            fill: false,
                            pointRadius: 0
                        },
                        // Punto √ìptimo (La Soluci√≥n)
                        {
                            label: `Asignaci√≥n √ìptima (${optX}, ${optY})`,
                            data: [{ x: optX, y: optY }],
                            backgroundColor: 'rgb(255, 0, 0)',
                            pointRadius: 12, 
                            pointStyle: 'rectRot' 
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true, 
                    aspectRatio: 1, 
                    scales: {
                        x: {
                            type: 'linear',
                            position: 'bottom',
                            title: { display: true, text: 'X (Empleados: Unidad Mayor Rentabilidad)' },
                            min: 0,
                            max: maxBoundary 
                        },
                        y: {
                            title: { display: true, text: 'Y (Empleados: Unidad Menor Rentabilidad)' },
                            min: 0,
                            max: maxBoundary 
                        }
                    },
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `√ìptimo: Unidad X=${context.parsed.x.toFixed(1)}, Unidad Y=${context.parsed.y.toFixed(1)}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        document.addEventListener('DOMContentLoaded', resolverYGraficar);
    </script>
</body>
</html>